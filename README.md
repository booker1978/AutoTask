自动化脚本执行引擎使用说明书

**版本**: 1.1.2025.1230

**适用对象**: 自动化测试人员、RPA 流程设计者

* * *

## 1.产品简介 (Introduction)

* * *

本程序是一款基于 **FlaUI** 技术构建的轻量级 Windows 自动化控制引擎。它支持通过编写简单的**文本指令脚本 (.txt)** 或使用**内置录制工具**，模拟人工对应用程序的操作（点击、输入、读取、验证）。

### 核心特性

* **脚本驱动**：纯文本指令，修改脚本即可改变流程，无需编译代码。
  
* **辅助录制**：内置“元素侦探”，支持 `Ctrl+Click` 快速生成定位代码。
  
* **混合模式**：同时支持 **UI 控件精准定位**（推荐）和 **鼠标坐标模拟**（兜底方案）。
  
* **智能等待**：内置重试机制，自动应对程序加载卡顿和网络延迟。
  
* **流程控制**：支持循环结构，轻松处理批量任务。
  

* * *

## 2. 脚本基础 (Syntax)

* * *

脚本文件为 UTF-8 编码的 `.txt` 文本。每一行代表一个执行步骤。

### 2.1 指令结构

        指令   定位符/参数1   [参数2/值]

* **指令 (Command)**：**必须大写**，例如 `CLICK`, `INPUT`。
  
* **定位符 (Target)**：
  
  * **控件定位**：`前缀:值` (如 `Name:登录`)。
    
  * **坐标定位**：`x,y` (如 `100,200`)，**注意：坐标均为相对于目标窗口左上角的相对坐标**。
    
* **参数 (Value)**：输入的文本、循环次数、断言内容等。
  

### 2.2 注释

使用 `//` 开头的行将被视为注释，执行时自动跳过。

        // 这是一个注释行
        CLICK Name:确定  // 行尾注释暂不支持，请分行写

* * *

## 3. 控件定位策略 (Locators)

* * *

在使用标准 UI 指令时，引擎支持三种定位方式。**推荐优先级：ID > Name > Index**。

### 3.1 定位方式详解

| **方式** | **格式** | **说明** | **示例** |
| --- | --- | --- | --- |
| **ID 定位** | `Id:控件ID` | **最推荐**。基于 AutomationId，不受界面文字变化影响。 | `Id:btnSubmit` |
| **Name 定位** | `Name:文本` | 基于控件显示的文字或 Name 属性。支持指定类型缩小范围。 | `Name:登录`<br>`Name:Button:保存` |
| **Index 定位** | `Index:类型:序号` | **万能兜底**。基于控件类型和在界面中的顺序（从0开始）。 | `Index:Edit:0` (第1个输入框) |

### 3.2 支持的控件关键字

用于 `Index` 定位或辅助 `Name` 定位（不区分大小写）：

| **交互类** | **输入/选择类** | **结构/显示类** |
| --- | --- | --- |
| `Button` (按钮) | `Edit` (输入框) | `TabItem` (选项卡) |
| `Hyperlink` (链接) | `ComboBox` (下拉框) | `TreeItem` (树节点) |
| `MenuItem` (菜单) | `CheckBox` (复选框) | `DataGrid` (表格) |
| `Image` (图片) | `List` (列表框) | `RadioButton` (单选) |

* * *

## 4. 指令详解 (Command Reference)

* * *

### 4.1 核心流程控制 (Core)

| **指令** | **说明** | **参数示例** |
| --- | --- | --- |
| **ATTACH** | **[必须]** 连接目标进程（不带.exe），需放在脚本第一行。 | `Wechat` |
| **WAIT** | 强制等待（毫秒）。用于处理硬性加载时间。 | `1000` |
| **LOG** | 在运行日志中打印信息，用于调试或记录进度。 | `=== 开始执行 ===` |
| **LOOP** | 循环开始，参数为循环次数。 | `5` |
| **END_LOOP** | 循环结束，必须与 LOOP 成对出现。 | (无) |

### 4.2 标准 UI 操作 (UI Automation)

**推荐使用**。直接操作控件对象，兼容性好，不依赖分辨率。

| **指令** | **说明** | **语法** | **示例** |
| --- | --- | --- | --- |
| **CLICK** | 点击控件。 | `CLICK 定位符` | `CLICK Name:保存` |
| **SELECT** | 下拉框/列表选择。 | `SELECT 定位符 索引/文本` | `SELECT Index:ComboBox:0 北京` |
| **ASSERT_TEXT** | 验证文本包含。 | `ASSERT_TEXT 定位符 预期值` | `ASSERT_TEXT Id:msg 成功` |
| **ASSERT_ENABLE** | 验证按钮可用。 | `ASSERT_ENABLE 定位符` | `ASSERT_ENABLE Id:btnNext` |
| **ASSERT_CHECKED** | 验证勾选状态。 | `ASSERT_CHECKED 定位符 [true/false]` | `ASSERT_CHECKED Name:同意 true` |

### 4.3 键盘与输入 (Input & Keyboard)

本工具区分“控件输入”与“模拟打字”。

| **指令** | **适用场景** | **说明** |
| --- | --- | --- |
| **INPUT** | **填写表单** (推荐) | `INPUT 定位符 文本`<br>先聚焦控件，再输入。支持 Excel 优化模式。 |
| **TYPE** | **盲打/快捷键** | `TYPE 文本或键码`<br>不寻找控件，直接向当前焦点窗口发送按键。 |

#### 💡 INPUT vs TYPE 选型指南

| **场景** | **推荐指令** | **原因** |
| --- | --- | --- |
| 填写用户名、密码 | **INPUT** | 稳定，会自动确保控件可见并聚焦。 |
| Excel 单元格录入 | **INPUT** | 内置了针对 Excel 编辑行为的特殊处理。 |
| 发送回车/Tab/退格 | **TYPE** | INPUT 无法发送纯功能键。 |
| 无法定位的弹窗/右键菜单 | **TYPE** | 配合 WAIT 使用，无需定位符，直接敲击键盘。 |

**TYPE 支持的特殊键码：** `{ENTER}` (回车), `{TAB}` (制表符), `{BACK}` (退格)。

### 4.4 鼠标模拟操作 (Mouse Simulation)

**兜底方案**。当控件无法识别时（如自绘界面、游戏画面），使用物理鼠标指令。

> ⚠️ **注意**：坐标为**相对坐标**（相对于窗口左上角）。窗口大小改变会导致点击位置偏移。

| **指令** | **说明** | **目标 (Target)** | **参数 (Value)** |
| --- | --- | --- | --- |
| **MOUSE_CLICK** | 左键单击 | `x,y` | -   |
| **MOUSE_RCLICK** | 右键单击 | `x,y` | -   |
| **MOUSE_DBLCLICK** | 左键双击 | `x,y` | -   |
| **MOUSE_MOVE** | 移动鼠标 | `x,y` | -   |
| **MOUSE_DRAG** | 拖拽操作 | `起点x,y` | `终点x,y` |
| **MOUSE_SCROLL** | 滚轮滚动 | `位置x,y` | `数值` (+向上, -向下) |

* * *

## 5. 脚本录制工具 (Recorder)

* * *

内置“元素侦探”工具，可极大提高脚本编写效率。

### 使用步骤

1. 启动本工具，并打开目标程序。
  
2. 点击工具栏 **“开始录制” (Start Spy)** 按钮。
  
3. 按住键盘 **`Ctrl`** 键不放。
  
4. 将鼠标移动到目标控件上，单击 **鼠标左键**（或右键）。
  
  * 红色边框出现，表示元素已被识别。
5. 工具界面会自动生成对应的脚本代码（优先生成 ID，其次为 Name）。
  
6. 松开 `Ctrl` 键完成当次录制。
  

> **智能策略**：
> 
> * 录制 **右键点击** 时，会自动生成 `MOUSE_RCLICK` 指令。
>   
> * 遇到无法识别的自定义控件，会自动降级生成 `MOUSE_CLICK x,y` 指令。
>   

* * *

## 6. 实战脚本示例

* * *

### 场景：微信发送消息（混合模式）

此脚本演示了循环、标准定位、鼠标模拟和键盘盲打的结合使用。

        // 1. 连接进程 (必须)
        ATTACH Wechat
        // 2. 循环执行 3 次
        LOOP 3
            LOG === 开始第 3 次发送任务 ===
    
            // 【标准操作】点击搜索框
            CLICK Name:搜索
            WAIT 500
    
            // 【控件输入】搜索联系人
            INPUT Name:搜索 文件传输助手
            WAIT 1000
    
            // 【鼠标模拟】点击搜索结果列表 (假设搜索结果无法被控件识别)
            // 坐标相对于微信窗口左上角
            MOUSE_CLICK 200,180
            WAIT 500
    
            // 【键盘盲打】模拟回车键，确保进入聊天窗口
            TYPE {ENTER}
    
            // 【控件输入】输入文字
            INPUT Name:输入框 自动化测试消息...
    
            // 【标准操作】点击发送按钮
            CLICK Name:发送
    
            WAIT 1000
        END_LOOP
    
        LOG === 脚本执行完毕 ===

* * *

## 7. 常见问题 (FAQ)

* * *

**Q1: 为什么鼠标指令 (MOUSE_*) 经常点不到位置？**

> **A:** 鼠标指令依赖**相对坐标**。如果录制时窗口是 800x600，执行时窗口变成了全屏，坐标位置就会对不上。
> 
> * **解决**：确保录制和执行时，目标程序窗口大小一致。推荐优先使用 `CLICK Name:...` 等不依赖坐标的标准指令。

**Q2: 脚本执行中途如何紧急停止？**

> **A:** 点击工具界面的 **Stop** 按钮。引擎会在每一步骤前（以及 WAIT 等待期间）检测停止信号，并在 1 秒内响应中断。

**Q3: ListBox / ComboBox 总是选不中？**

> **A:** 可能是数据“懒加载”导致的。
> 
> * **解决**：在 `SELECT` 指令前加一行 `WAIT 1000` 给程序一点加载时间。如果依然失败，请确保鼠标不要在执行期间乱动，引擎会自动降级尝试模拟键盘方向键进行选择。

**Q4: 右键菜单怎么操作？**

> **A:** 右键菜单通常属于独立的弹出窗口，建议分两步：
> 
> 1. 使用录制器的“右键录制”生成 `MOUSE_RCLICK` 弹出菜单。
>   
> 2. 再次录制，生成 `MOUSE_CLICK` 点击具体的菜单项（推荐使用坐标点击菜单项，最稳妥）。
>
